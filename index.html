<!doctype html>
<html lang="fr">
<head>
  <title>Sport en plein air</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="styles.css" type="text/css">

  <!-- Début header pour la gestion du choix d'une date -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
    $( function() {
      $( "#texteFormulaireJour" ).datepicker({
        altField: "#datepicker",
        closeText: 'Fermer',
        prevText: 'Précédent',
        nextText: 'Suivant',
        currentText: 'Aujourd\'hui',
        monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
        monthNamesShort: ['Janv.', 'Févr.', 'Mars', 'Avril', 'Mai', 'Juin', 'Juil.', 'Août', 'Sept.', 'Oct.', 'Nov.', 'Déc.'],
        dayNames: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'],
        dayNamesShort: ['Dim.', 'Lun.', 'Mar.', 'Mer.', 'Jeu.', 'Ven.', 'Sam.'],
        dayNamesMin: ['D', 'L', 'M', 'M', 'J', 'V', 'S'],
        weekHeader: 'Sem.',
        dateFormat: 'dd/mm/y'
      });
    } );
  </script>
  <!-- Fin header pour la gestion du choix d'une date -->



</head>
<body>
  <!-- Titre principal de la page -->
  <h1 align="center"> Bienvenue sur sport en plein air </h1>

  <div id="zoneConnexion">
    <h2>Gestion compte</h2> 
    <!-- Début ajout d'une nouvelle date -->
    <form>
      <table>
        <tr>
          <td>
            <label for="texte" >Mail : </label>
          </td>
          <td width="800px">
            <input type="text" name="mailConnexion" id="mailConnexion" style=' background-color: #e0e0e0; border: 1px solid #ffffff; padding: 4px; border-radius: 20px; font-family: tahoma; text-align: center;'>
          </td>
        </tr>
          <td>
            <label for="texte" >Latitude : </label>
          </td>
          <td>
            <input type="text" name="latitudeConnexion" id="latitudeConnexion" style=' background-color: #e0e0e0; border: 1px solid #ffffff; padding: 4px; border-radius: 20px; font-family: tahoma; text-align: center;'>
          </td>
        </tr>
        <tr>
          <td>
            <label for="texte" >Longitude :  </label>
          </td>
          <td>
            <input type="text" name="longitudeConnexion" id="longitudeConnexion" style=' background-color: #e0e0e0; border: 1px solid #ffffff; padding: 4px; border-radius: 20px; font-family: tahoma; text-align: center;'>
          </td>
        </tr>
        <tr>
      </table>

      <input type="submit" value="Se connecter" id="validConnexion">
    </form>
  </div> 

  <!-- Div contenant le bouton de déconnexion -->
  <div id="zoneDeconnexion">
    <input type="submit" value="Se déconnecter" id="validDeconnexion">
  </div>

  <div id="zonePersConnect">
    <div style="margin:8px;background:green;">
      <!-- Début des information sur l'utilisateur -->
      <h2> Information sur l'utilisateur </h2>
      <table>
        <tr>
          <td>
            Nom : 
          </td>
          <td id="prenom_nom">

          </td>
        </tr>
        <tr>
          <td>
            Position : 
          </td>
          <td id="position_utilisateur">
          </td>
        </tr>
        <tr>
          <td>
            Status : 
          </td>
          <td id="rs">
          </td>
        </tr>
      </table>
    </div>
    <!-- Fin des messages sur l'utilisateur -->

    <!-- Affichage de la météo du jour actuel -->
    <div id="meteo">
        <input type="submit" value="Actualiser la météo" id="actualiserMeteo" onclick="actualiserMeteo();">

<!-- <script src='http://openweathermap.org/themes/openweathermap/assets/vendor/owm/js/d3.min.js'></script><div id='openweathermap-widget'></div>
                    <script type='text/javascript'>
                    window.myWidgetParam = {
                        id: 21,
                        cityid: 6453974,
                        appid: '',
                        units: 'metric',
                        containerid: 'openweathermap-widget',                        
                    };
                    (function() {
                        var script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.async = true;
                        script.src = 'http://openweathermap.org/themes/openweathermap/assets/vendor/owm/js/weather-widget-generator.js';
                        var s = document.getElementsByTagName('script')[0];
                        s.parentNode.insertBefore(script, s);
                    })();
                  </script> -->


    </div>
    <!-- Fin affichage de la météo du jour actuel -->









    <div width="100%" >
      <!-- Partie gauche de la page : mes créneaux -->
      <span id="dateGauche" >
        <h2>Mes dates de sport en plein air</h2> 
        <!-- Début ajout d'une nouvelle date -->
        <form>
          <label for="texte" >Jour &nbsp;&nbsp;  &nbsp; </label>
          <input type="date" name='texteFormulaireJour' id='texteFormulaireJour' style=' background-color: #e0e0e0; border: 1px solid #ffffff; padding: 4px; border-radius: 4px; font-family: tahoma; text-align: center;'>
          <br/>
          <label for="texte">Sport</label>
          <input type="text" name="texteFormulaireSport" id="texteFormulaireSport" style=' background-color: #e0e0e0; border: 1px solid #ffffff; padding: 4px; border-radius: 4px; font-family: tahoma; text-align: center;'>
          <br/>
          <input type="submit" value="Add date" id="validAddSport">
        </form>


        <span id="mySport" >
        </span>



        <!-- Fin ajout d'une nouvelle date -->

      </span>
      <!-- Fin partie gauche de la page : mes créneaux -->



      <!-- Partie droite de la page : les créneaux des autres présents dans ma zone -->
      <span id="dateDroite" >
        <div id="meteo">
          <input type="submit" value="Actualiser" id="actualiserSports" onclick="dateNear();">
        </div>
        <h2>Les dates de sport en plein air des autres membres</h2> 

        <span id="sportNear">
        </span>

      </span>
      <!-- Fin partie droite de la page : les créneaux des autres présents dans ma zone -->
    </div>


  </div>



  <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
  <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
  <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
  <div class="wrap">



    <p id="readyState">readyState : <span id="rs">&nbsp;</span></p>

    <p><strong>Journal des échanges</strong></p>
    <div name="log" id="log"></div>

    <form>
      <p>
        <label for="texte">Envoyer</label>
        <input type="text" name="texte" id="texte">
        <input type="submit" value="OK" id="valid">
      </p>

    </form>

  </div>


  <script>

    var ws = null;

    var userID;
//  Création d'un nouveau socket
// (Pour Mozilla < 11 avec version préfixée)
if('MozWebSocket' in window) {

  ws = new MozWebSocket("ws://192.168.1.22:1337/phpwebsocket/chat.php");

} else if('WebSocket' in window) {

  ws = new WebSocket("ws://192.168.1.22:1337/phpwebsocket/chat.php");

}

if(typeof ws !=='undefined') {

// Indication de l'état
var rs = document.getElementById('rs');


function initSession(userID1,lat,long){
  var envoi={};
  envoi.commande="CONNECT";
  var personne={};
  personne.id=userID1;
    // personne.nom="DEGIRONDE";
    // personne.prenom="ROBIN";
    personne.latitude=lat;
    personne.longitude=long;
    // personne.mdp="mdp";

    envoi.data=JSON.stringify(personne);
    var json= JSON.stringify(envoi);

// Envoi des variables de connexion
ws.send(json);
log("> "+json);

// Mise à zéro du champ et focus
texte.focus();
texte.value = '';

}

// Récupération de toutes les dates prévues par cette personne
function mesDates(){
  var envoi={};
  envoi.commande = "MYSPORT";
  var json= JSON.stringify(envoi);

  // Envoi des variables de connexion
  ws.send(json);
  log("> "+json);


}


function dateNear(){
  var envoi={};
  envoi.commande = "ALLSPORTNEAR";
  var json= JSON.stringify(envoi);

  // Envoi des variables de connexion
  ws.send(json);
  log("> "+json);

}


// Lors de l'ouverture de connexion
ws.onopen = function() {
  log("Socket ouvert");
  rs.innerHTML = this.readyState;
};

// Lors de la réception d'un message
ws.onmessage = function(e) {
// Ajout au journal du contenu du message
var msg = e.data;
log("<  "+msg);

//Traitement des messages reçus
var msgParse = JSON.parse(msg);
log("<  "+msgParse.data);
// Affichage de tous les sports de la personne connectée
if (msgParse.commande == "MYSPORT")
{
  // on met a jour la liste de mes sports
  var mySport = document.getElementById('mySport');

  // On parcourt tous les sports un par un
  for (variable in msgParse.data)
  {
    for (var v2 in msgParse.data[variable])
    {
      var temp ="";
      temp += "<div id=\"creneauSport_"+variable+"_"+msgParse.data[variable][v2]+"\" style=\"float: left;  margin: 10px; border: 1px solid #73ba74; border-left: 4px solid #73ba74; border-radius: 5px; background-color: #a3da94\">\n";
      temp += "<div ><button style=\"font-family: tahoma; font-size: 11px; text-align: center; float: right; background-color: #73ba74; height: 18px; width: 20px; color: #ffffff\"   id=\"validRemoveSport\" onclick=\"removeMySport('"+variable+"','"+msgParse.data[variable][v2]+"')\" >X</button></div>\n";
      temp += "<div style=\"margin: 10px; margin-top: 4px;\">\n";
      temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\"><b>"+msgParse.data[variable][v2]+"</b></div>\n";
      temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">"+variable+"</div>\n";
      temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">Nbre de participants actuel</div>\n";
      temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">Météo</div>\n";
      temp += "</div>\n";
      temp += "</div>\n";
      mySport.innerHTML += temp;
      
      log("\n\n "+variable + " => " + msgParse.data[variable][v2]);
    }
  }

}
// Affichage du sport venant d'être ajouté
else if (msgParse.commande == "ADDSPORT")
{
  var mySport = document.getElementById('mySport');
  var newSport = JSON.parse(msgParse.data);
  var temp ="";
  temp += "<div id=\"creneauSport_"+newSport.nom+"_"+newSport.date+"\" style=\"float: left;  margin: 10px; border: 1px solid #73ba74; border-left: 4px solid #73ba74; border-radius: 5px; background-color: #a3da94\">\n";
  temp += "<div ><button style=\"font-family: tahoma; font-size: 11px; text-align: center; float: right; background-color: #73ba74; height: 18px; width: 20px; color: #ffffff\" id=\"validRemoveSport\" onclick=\"removeMySport('"+newSport.nom+"','"+newSport.date+"')\">X</button></div>\n";
  temp += "<div style=\"margin: 10px; margin-top: 4px;\">\n";
  temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\"><b>"+newSport.date+"</b></div>\n";
  temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">"+newSport.nom+"</div>\n";
  temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">Nbre de participants actuel</div>\n";
  temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">Météo</div>\n";
  temp += "</div>\n";
  temp += "</div>\n";
  mySport.innerHTML += temp;
}
//Affichage de tous les sports pratiqués par les personnes à proximité
else if (msgParse.commande == "ALLSPORTNEARREP")
{
  // on met a jour la liste de mes sports
  var sportNear = document.getElementById('sportNear');
  sportNear.innerHTML = "";

  // On parcourt toutes les personnes à proximité
  for (personne in msgParse.data)
  {

    // On parcourt tous les sports un par un
    for (sport in msgParse.data[personne].creneaux)
    {

          // on parcourt désormais toutes les dates de ce sport
          for (var variable in msgParse.data[personne].creneaux[sport])
          {
            var temp ="";
            temp += "<div id=\"creneauSport_"+msgParse.data[personne].prenom+"_"+sport+"_"+msgParse.data[personne].creneaux[sport][variable]+"\" style=\"float: left;  margin: 10px; border: 1px solid #73ba74; border-left: 4px solid #73ba74; border-radius: 5px; background-color: #a3da94\">\n";
            temp += "<div ><button style=\"font-family: tahoma; font-size: 11px; text-align: center; float: right; background-color: #73ba74; height: 18px; width: 40px; color: #ffffff\" id=\"validAdd\" onclick=\"addSport('"+sport+"','"+msgParse.data[personne].creneaux[sport][variable]+"')\">add</button></div>\n";
            temp += "<div style=\"margin: 10px; margin-top: 4px;\">\n";
            temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\"><b>"+msgParse.data[personne].creneaux[sport][variable]+"</b></div>\n";
            temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">"+sport+"</div>\n";
            temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">Par "+msgParse.data[personne].prenom+" "+msgParse.data[personne].nom+"</div>\n";
            temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">Nbre de participants actuel</div>\n";
            temp += "<div style=\"width: 180px; overflow: hidden; font-family: tahoma; font-size: 15px; color: black\">Météo</div>\n";
            temp += "</div>\n";
            temp += "</div>\n";
            sportNear.innerHTML += temp;

  //       log("\n\n "+temp ;
}
}
}
}
else if (msgParse.commande == "CONNECTREP")
{

  var x = JSON.parse(msgParse.data);
  // On rempli les champs associés
  document.getElementById('prenom_nom').innerHTML = x.prenom + " " + x.nom;
  document.getElementById('position_utilisateur').innerHTML = "longitude : " + x.longitude + " et latitude : " + x.latitude;

}
else if (msgParse.commande == "GETMETEOJSONREP")
{

  var x = JSON.parse(msgParse.data);
  // log("===> "+JSON.parse(x.weather[0]).icon);

  // On rempli les champs associés
  var temp = "";
  // temp += "<input type=\"submit\" value=\"Actualiser la météo\" id=`\"actualiserMeteo\" onclick=\"actualiserMeteo();\">";
  temp += "<table>";
  temp += "<tr>";
  temp += "<td collspan=2>";
  temp += "<img src=\"http://openweathermap.org/img/w/"+x.weather[0].icon+".png\"  >";
  temp += "</td>";
  temp += "</tr>";
  temp += "<tr>";
  temp += "<tr>";
  temp += "<td>";
  temp += "Temperature actuelle :"
  temp += "</td>";
  temp += "<td>";
  temp += x.main.temp;
  temp += "</td>";
  temp += "</tr>";
  temp += "<tr>";
  temp += "<td>";
  temp += "Temperature max :"
  temp += "</td>";
  temp += "<td>";
  temp += x.main.temp_min;
  temp += "</td>";
  temp += "</tr>";
  temp += "<tr>";
  temp += "<td>";
  temp += "Temperature min :"
  temp += "</td>";
  temp += "<td>";
  temp += x.main.temp_max;
  temp += "</td>";
  temp += "</tr>";
  // temp += "<td>";
  // temp += "</td>";
  // temp += "<td>";
  // temp += "</td>";
  // temp += "</tr>";
  // temp += "<tr>";
  // temp += "<td>";
  // temp += "</td>";
  // temp += "<td>";
  // temp += "</td>";
  // temp += "</tr>";
  // temp += "<tr>";
  // temp += "<td>";
  // temp += "</td>";
  // temp += "<td>";
  // temp += "</td>";
  // temp += "</tr>";
  temp += "</table>";
  document.getElementById('meteo').innerHTML = temp;

}
else if (msgParse.commande == "ALERTPROXIMITE")
{
  // on actualise les données de tous les voisins
  // setTimeout(dateNear(),7000);
}


rs.innerHTML = this.readyState;


};

// Lors d'une erreur de connexion
ws.onerror = function(e) {  
  log("Erreur de connexion");
  rs.innerHTML = this.readyState;
};

// Lors de la fermeture de connexion
ws.onclose = function(e) {  
  if(e.wasClean) {
    log("Socket fermé proprement");
  } else {
    log("Socket fermé");
    if(e.reason) log(e.reason);
  }
  rs.innerHTML = this.readyState;
};

// Evénement submit du formulaire
document.getElementsByTagName('form')[2].onsubmit = function(e) {
  var texte = document.getElementById('texte');

// Envoi de la chaîne texte
ws.send(texte.value);
log("> "+texte.value);

// Mise à zéro du champ et focus
// texte.focus();
texte.value = '';

// Empêche de valider le formulaire
e.preventDefault();
};

// Connexion utilisateur
document.getElementsByTagName('form')[0].onsubmit = function(e) {
  var mail = document.getElementById('mailConnexion');
  var latitude = document.getElementById('latitudeConnexion');
  var longitude = document.getElementById('longitudeConnexion');


  // On initialise l'utilisateur
  initSession(mail.value,latitude.value,longitude.value);

  // On affiche tous les sports avec les créneaux associés
  setTimeout(mesDates(),5000);
  // on récupère les sports des personnes se trouvant à proximité
  // setTimeout(dateNear(),7000);
  // setTimeout(dateNear(),3000);

 //essayer avec 
  // setInterval(dateNear(),1000);
  //setInterval(dateNear(){go();},1000);


  // on valide la zone
  document.getElementById('zoneConnexion').style.visibility = "hidden";
  document.getElementById('zoneConnexion').style.height = "0";
  document.getElementById('zoneDeconnexion').style.visibility = "visible";
  document.getElementById('zoneDeconnexion').style.height = "auto";
  document.getElementById('zonePersConnect').style.visibility = "visible";
  document.getElementById('zonePersConnect').style.height = "auto";


   


// Empêche de valider le formulaire
e.preventDefault();
};






// Ajout d'une date pour faire du sport
document.getElementsByTagName('form')[1].onsubmit = function(e) {
  var texteFormulaireJour = document.getElementById('texteFormulaireJour');
  var texteFormulaireSport = document.getElementById('texteFormulaireSport');

// Envoi de la chaîne texte
var envoi={};
envoi.commande="ADDCRENEAU";
var monSport = {} ;
monSport.id = userID;
monSport.nom = texteFormulaireSport.value;
monSport.date =  texteFormulaireJour.value;


envoi.data=JSON.stringify(monSport);


var json= JSON.stringify(envoi);


// Envoi des variables de connexion
ws.send(json);
log("> "+json);

// Mise à zéro des champ et focus
texteFormulaireSport.value = '';
texteFormulaireJour.value = '';
// TODO : On peut le retirer 
// texte.focus();
texte.value = '';
//TODO : fin de ont peut le retirer


// Empêche de valider le formulaire
e.preventDefault();


};

document.getElementsByTagName()



} else {

  alert("Ce navigateur ne supporte pas Web Sockets");

}

// Fonction d’ajout au journal
function log(txt) {
  document.getElementById('log').innerHTML += txt + "<br>\n";
}



function removeMySport(sport,date) {
  // Envoi de la chaîne texte
  var envoi={};
  envoi.commande="DELETEDATE";
  var monSport = {} ;
  monSport.id = userID;
  monSport.nom = sport;
  monSport.date =  date;


  envoi.data=JSON.stringify(monSport);


  var json= JSON.stringify(envoi);


  // Envoi des variables de connexion
  ws.send(json);
  log("> "+json);

  // on retire de l'affichage le sport supprimé
  var elementID = 'creneauSport_'+sport+'_'+date;

  document.getElementById(elementID).style.display = 'none';

}

function addSport(sport,date){
  // Envoi de la chaîne texte
  var envoi={};
  envoi.commande="ADDCRENEAU";
  var monSport = {} ;
  monSport.id = userID;
  monSport.nom = sport;
  monSport.date =  date;


  envoi.data=JSON.stringify(monSport);


  var json= JSON.stringify(envoi);


  // Envoi des variables de connexion
  ws.send(json);
  log("> : "+json);
}


function actualiserMeteo() {
  var envoi={};
  envoi.commande="GETMETEOJSON";

  var json= JSON.stringify(envoi);
  // Envoi des variables de connexion
  ws.send(json);
}


</script>

</body>
</html>
